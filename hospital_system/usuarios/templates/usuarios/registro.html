<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Registro | Hospital System</title>
  {% load static %}
  <link rel="icon" href="{% static 'img/favicon.png' %}?v=2" type="image/png">

  <!-- Metas responsivas y accesibles -->
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="color-scheme" content="light dark">
  <meta name="description" content="Formulario de registro de usuario para Hospital System. Interfaz accesible, segura y profesional.">
  <meta http-equiv="x-ua-compatible" content="IE=edge">

  <!-- Bootstrap y FontAwesome -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

  <style>
    :root{
      --bg-light: linear-gradient(135deg, #e0f7fa, #e8f5e9);
      --card-bg: rgba(255, 255, 255, 0.97);
      --text: #1f2937;
      --text-muted: #6b7280;
      --brand: #22c55e;
      --brand-700: #16a34a;
      --danger: #dc3545;
      --focus-ring: rgba(34, 197, 94, 0.25);
      --shadow: 0 8px 24px rgba(0,0,0,0.12);
    }
    @media (prefers-color-scheme: dark){
      :root{
        --bg-light: linear-gradient(135deg, #0b1220, #101826);
        --card-bg: rgba(17, 24, 39, 0.95);
        --text: #e5e7eb;
        --text-muted: #9ca3af;
        --brand: #22c55e;
        --brand-700: #16a34a;
        --danger: #ef4444;
        --focus-ring: rgba(34, 197, 94, 0.25);
        --shadow: 0 10px 28px rgba(0,0,0,0.45);
      }
    }
    @media (prefers-reduced-motion: reduce){
      *{ animation: none !important; transition: none !important; scroll-behavior: auto !important; }
    }

    body{
      background: var(--bg-light);
      font-family: 'Segoe UI', system-ui, -apple-system, Roboto, Arial, sans-serif;
      min-height: 100vh;
      display: grid;
      place-items: center;
      margin: 0;
      padding: clamp(16px, 4vw, 32px);
    }

    .card{
      width: min(100%, 520px);
      padding: clamp(20px, 4vw, 28px);
      border-radius: 16px;
      background: var(--card-bg);
      box-shadow: var(--shadow);
      border: none;
      animation: fadeIn 600ms ease-out;
    }

    .title{
      display: flex; align-items: center; justify-content: center; gap: 10px;
      color: var(--brand);
      font-weight: 800;
      letter-spacing: .3px;
      margin-bottom: 16px;
    }

    .form-label{ font-weight: 600; color: var(--text); }
    .input-group-text{ background-color: rgba(0,0,0,.05); border: 1px solid rgba(0,0,0,.12); }
    .form-control, .form-select{
      border-radius: 10px; padding: 10px 12px;
      border: 1px solid rgba(0,0,0,.12);
      background-clip: padding-box;
    }
    .form-control:focus, .form-select:focus{
      border-color: var(--brand);
      box-shadow: 0 0 0 .2rem var(--focus-ring);
      outline: none;
    }

    .password-toggle{
      cursor: pointer; color: var(--text-muted);
    }
    .password-meter{
      display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; margin-top: 10px;
    }
    .meter-bar{
      height: 8px; border-radius: 6px; background: #e5e7eb;
    }
    .meter-bar.active.weak{ background: #f97316; }     /* naranja */
    .meter-bar.active.medium{ background: #22c55e; }   /* verde */
    .meter-bar.active.strong{ background: #16a34a; }   /* verde oscuro */

    .help-text{ font-size: .9rem; color: var(--text-muted); }

    .alert{ border-radius: 10px; }

    .btn-primary{
      background: var(--brand); border-color: var(--brand);
      border-radius: 12px; font-weight: 700; padding: 12px;
      box-shadow: 0 6px 18px rgba(34,197,94,0.22);
    }
    .btn-primary:hover{ background: var(--brand-700); border-color: var(--brand-700); }

    .footer-note{
      margin-top: 10px; color: var(--text-muted); font-size: .95rem; text-align: center;
    }

    .terms{
      display: flex; gap: 10px; align-items: flex-start; color: var(--text);
    }
    .terms input{ margin-top: 3px; }

    .field-error{
      color: var(--danger); font-size: .9rem; margin-top: 6px;
    }

    @keyframes fadeIn { from{opacity:0; transform: translateY(12px)} to{opacity:1; transform: translateY(0)} }
  </style>
</head>
<body>
  <main class="card" role="main" aria-labelledby="title">
    <h2 id="title" class="title">
      <i class="fas fa-user-plus"></i> Crear cuenta
    </h2>

    {% if messages %}
      {% for message in messages %}
        <div class="alert alert-success text-center" role="alert">{{ message }}</div>
      {% endfor %}
    {% endif %}

    {% if form.non_field_errors %}
      <div class="alert alert-danger" role="alert">
        {% for err in form.non_field_errors %}{{ err }}{% endfor %}
      </div>
    {% endif %}

    <form method="post" novalidate id="registerForm" class="needs-validation" aria-describedby="form-help">
      {% csrf_token %}

      <!-- Nombre -->
      <div class="mb-3">
        <label for="{{ form.first_name.id_for_label }}" class="form-label">Nombre</label>
        <div class="input-group has-validation">
          <span class="input-group-text" aria-hidden="true"><i class="fas fa-user"></i></span>
          <input type="text"
                 name="{{ form.first_name.name }}"
                 id="{{ form.first_name.id_for_label }}"
                 class="form-control {% if form.first_name.errors %}is-invalid{% endif %}"
                 value="{{ form.first_name.value|default_if_none:'' }}"
                 placeholder="Tu nombre"
                 autocomplete="given-name"
                 required>
          <div class="invalid-feedback">
            {% if form.first_name.errors %}{% for e in form.first_name.errors %}{{ e }}{% endfor %}{% else %}Introduce tu nombre.{% endif %}
          </div>
        </div>
      </div>

      <!-- Apellido -->
      <div class="mb-3">
        <label for="{{ form.last_name.id_for_label }}" class="form-label">Apellido</label>
        <div class="input-group has-validation">
          <span class="input-group-text" aria-hidden="true"><i class="fas fa-user"></i></span>
          <input type="text"
                 name="{{ form.last_name.name }}"
                 id="{{ form.last_name.id_for_label }}"
                 class="form-control {% if form.last_name.errors %}is-invalid{% endif %}"
                 value="{{ form.last_name.value|default_if_none:'' }}"
                 placeholder="Tu apellido"
                 autocomplete="family-name"
                 required>
          <div class="invalid-feedback">
            {% if form.last_name.errors %}{% for e in form.last_name.errors %}{{ e }}{% endfor %}{% else %}Introduce tu apellido.{% endif %}
          </div>
        </div>
      </div>

      <!-- Email -->
      <div class="mb-3">
        <label for="{{ form.email.id_for_label }}" class="form-label">Correo electrónico</label>
        <div class="input-group has-validation">
          <span class="input-group-text" aria-hidden="true"><i class="fas fa-envelope"></i></span>
          <input type="email"
                 name="{{ form.email.name }}"
                 id="{{ form.email.id_for_label }}"
                 class="form-control {% if form.email.errors %}is-invalid{% endif %}"
                 value="{{ form.email.value|default_if_none:'' }}"
                 placeholder="tucorreo@ejemplo.com"
                 autocomplete="email"
                 inputmode="email"
                 required>
          <div class="invalid-feedback">
            {% if form.email.errors %}{% for e in form.email.errors %}{{ e }}{% endfor %}{% else %}Introduce un correo válido.{% endif %}
          </div>
        </div>
        <p class="help-text mt-2">Usaremos tu correo para confirmar tu cuenta y notificarte sobre tus citas.</p>
      </div>

      <!-- Password 1 -->
      <div class="mb-3">
        <label for="{{ form.password1.id_for_label }}" class="form-label">Contraseña</label>
        <div class="input-group has-validation">
          <span class="input-group-text" aria-hidden="true"><i class="fas fa-lock"></i></span>
          <input type="password"
                 name="{{ form.password1.name }}"
                 id="{{ form.password1.id_for_label }}"
                 class="form-control {% if form.password1.errors %}is-invalid{% endif %}"
                 placeholder="Mínimo 8 caracteres"
                 autocomplete="new-password"
                 required>
          <button type="button" class="input-group-text password-toggle" aria-label="Mostrar/ocultar contraseña" data-target="{{ form.password1.id_for_label }}">
            <i class="fa-regular fa-eye"></i>
          </button>
          <div class="invalid-feedback">
            {% if form.password1.errors %}{% for e in form.password1.errors %}{{ e }}{% endfor %}{% else %}La contraseña no cumple los requisitos.{% endif %}
          </div>
        </div>

        <!-- Medidor de seguridad -->
        <div class="password-meter" aria-hidden="true">
          <div class="meter-bar" id="meter-1"></div>
          <div class="meter-bar" id="meter-2"></div>
          <div class="meter-bar" id="meter-3"></div>
          <div class="meter-bar" id="meter-4"></div>
        </div>
        <p class="help-text mt-2" id="password-help">
          Usa mayúsculas, minúsculas, números y símbolos para una contraseña fuerte.
        </p>
      </div>

      <!-- Password 2 -->
      <div class="mb-3">
        <label for="{{ form.password2.id_for_label }}" class="form-label">Confirmar contraseña</label>
        <div class="input-group has-validation">
          <span class="input-group-text" aria-hidden="true"><i class="fas fa-lock"></i></span>
          <input type="password"
                 name="{{ form.password2.name }}"
                 id="{{ form.password2.id_for_label }}"
                 class="form-control {% if form.password2.errors %}is-invalid{% endif %}"
                 placeholder="Repite la contraseña"
                 autocomplete="new-password"
                 required>
          <button type="button" class="input-group-text password-toggle" aria-label="Mostrar/ocultar confirmar contraseña" data-target="{{ form.password2.id_for_label }}">
            <i class="fa-regular fa-eye"></i>
          </button>
          <div class="invalid-feedback">
            {% if form.password2.errors %}{% for e in form.password2.errors %}{{ e }}{% endfor %}{% else %}Las contraseñas no coinciden.{% endif %}
          </div>
        </div>
      </div>

      <!-- Términos -->
      <div class="mb-3 terms">
        <input type="checkbox" id="terms" required aria-required="true">
        <label for="terms">
          Acepto los <a href="#" target="_blank" rel="noopener">términos y condiciones</a> y la <a href="#" target="_blank" rel="noopener">política de privacidad</a>.
        </label>
      </div>

      <!-- Submit -->
      <button type="submit" class="btn btn-primary w-100">
        <i class="fas fa-check-circle me-2"></i> Registrarse
      </button>

      <p id="form-help" class="footer-note">
        Tu información se gestionará de forma segura. Puedes cambiar tus datos más adelante en tu perfil.
      </p>
    </form>

    <div class="mt-3 text-center">
      <p>¿Ya tienes cuenta? <a href="{% url 'usuarios:login' %}">Inicia sesión</a></p>
    </div>
  </main>

  <!-- JS Bootstrap (opcional) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" defer></script>

  <!-- Experiencia + validación del formulario -->
  <script>
    (function(){
      const form = document.getElementById('registerForm');
      const pwd1 = document.getElementById('{{ form.password1.id_for_label }}');
      const pwd2 = document.getElementById('{{ form.password2.id_for_label }}');
      const bars = [
        document.getElementById('meter-1'),
        document.getElementById('meter-2'),
        document.getElementById('meter-3'),
        document.getElementById('meter-4')
      ];

      // Toggle mostrar/ocultar contraseña
      document.querySelectorAll('.password-toggle').forEach(btn => {
        btn.addEventListener('click', () => {
          const targetId = btn.getAttribute('data-target');
          const input = document.getElementById(targetId);
          const icon = btn.querySelector('i');
          if(input.type === 'password'){
            input.type = 'text';
            icon.classList.remove('fa-eye');
            icon.classList.add('fa-eye-slash');
          } else {
            input.type = 'password';
            icon.classList.remove('fa-eye-slash');
            icon.classList.add('fa-eye');
          }
        });
      });

      // Medidor de seguridad básico
      const strength = (v) => {
        let score = 0;
        if(v.length >= 8) score++;
        if(/[A-Z]/.test(v) && /[a-z]/.test(v)) score++;
        if(/[0-9]/.test(v)) score++;
        if(/[^A-Za-z0-9]/.test(v)) score++;
        return score;
      };
      const paintBars = (score) => {
        bars.forEach((b,i) => {
          b.classList.remove('active','weak','medium','strong');
          if(i < score){
            b.classList.add('active',
              score <= 1 ? 'weak'
              : score <= 3 ? 'medium'
              : 'strong'
            );
          }
        });
      };
      pwd1.addEventListener('input', (e) => paintBars(strength(e.target.value)));

      // Validación HTML5 + coincidencia de contraseñas
      form.addEventListener('submit', (e) => {
        // fuerza validación nativa
        if(!form.checkValidity()){
          e.preventDefault();
          e.stopPropagation();
        }
        // validación extra: contraseñas iguales
        if(pwd1.value !== pwd2.value){
          e.preventDefault();
          e.stopPropagation();
          pwd2.classList.add('is-invalid');
          const feedback = pwd2.parentElement.querySelector('.invalid-feedback');
          if(feedback) feedback.textContent = 'Las contraseñas no coinciden.';
        }
        form.classList.add('was-validated');
      });
    })();
  </script>
</body>
</html>
